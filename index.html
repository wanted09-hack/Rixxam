<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Ayrix ‚Äì Live Sync Player</title>

  <link rel="manifest" href="manifest.json">
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>
    <link rel="icon" type="image/png" sizes="192x192" href="icons/ayrix-icon-192.png">
  <link rel="apple-touch-icon" href="icons/ayrix-icon-192.png">
  <meta name="theme-color" content="#05000b">


  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
        * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ff4da6 0, transparent 55%),
                  radial-gradient(circle at bottom, #7b5dff 0, transparent 55%),
                  #050515;
      min-height: 100vh;
      display: flex;
      align-items: center;       /* center vertically */
      justify-content: center;   /* center horizontally */
      color: #f8f2ff;
    }

    .app {
      width: 90%;
max-width: 600px;
      
margin: 0 auto;
      background: rgba(8, 6, 24, 0.96);
      border-radius: 24px;
      padding: 20px 18px;
      box-shadow:
        0 18px 45px rgba(0, 0, 0, 0.7),
        0 0 35px rgba(255, 77, 166, 0.55),
        0 0 60px rgba(123, 93, 255, 0.45);
      backdrop-filter: blur(18px);
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.5rem;
      text-align: center;
      letter-spacing: 0.03em;
    }

    .subtitle {
      text-align: center;
      font-size: 0.8rem;
      margin-bottom: 14px;
      opacity: 0.8;
    }

    #hostToggle {
      display: block;
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      margin-bottom: 10px;
      cursor: pointer;
      background: linear-gradient(90deg, #252047, #342a63);
      color: #f6ebff;
      transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    #hostToggle.host {
      background: linear-gradient(90deg, #ff4fa0, #ff7edb);
      color: #fff;
      box-shadow: 0 0 18px rgba(255, 79, 160, 0.7);
    }

    #hostToggle:active {
      transform: scale(0.98);
    }

    audio {
      width: 100%;
      margin: 12px 0 10px;
      filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.4));
    }

    #status {
      font-size: 0.78rem;
      text-align: center;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    #songs {
      max-height: 390px;
      overflow-y: auto;
      margin-top: 10px;
      padding-right: 2px;
    }

    .song-button {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 14px;
      border: none;
      text-align: left;
      font-size: 0.86rem;
      cursor: pointer;
      background: rgba(23, 18, 52, 0.95);
      color: #f7e9ff;
      transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    .song-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
    }

    .song-button.playing {
      background: linear-gradient(90deg, #ff4fa0, #7f5dff);
      color: #fff;
      box-shadow:
        0 0 14px rgba(255, 79, 160, 0.7),
        0 0 22px rgba(127, 93, 255, 0.6);
      transform: translateY(-1px) scale(1.01);
    }

    .song-button.playing::before {
      content: "‚óè ";
      color: #ffe9ff;
    }
    /* === New Ayrix Splash (Overlay + No Glitch) === */

#ayrix-splash {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  background: radial-gradient(circle at top, #15001f, #050008 60%);
  animation: ayrixSplashIn 0.5s ease-out forwards;
}

#ayrix-splash.hide {
  animation: ayrixSplashOut 0.6s ease-in forwards;
}

.ayrix-splash-inner {
  text-align: center;
  padding: 24px;
}

.ayrix-splash-logo {
  width: 90px;
  height: 90px;
  border-radius: 24px;
  box-shadow: 0 0 35px rgba(255, 80, 200, 0.6);
}

.ayrix-splash-title {
  margin-top: 12px;
  font-size: 1.3rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  text-transform: uppercase;
}

.ayrix-splash-subtitle {
  margin-top: 5px;
  font-size: 0.7rem;
  opacity: 0.85;
  letter-spacing: 0.13em;
  text-transform: uppercase;
}

/* Fade-in animation */
@keyframes ayrixSplashIn {
  0% { opacity: 0; transform: scale(0.96); }
  100% { opacity: 1; transform: scale(1); }
}

/* Fade-out animation */
@keyframes ayrixSplashOut {
  0% { opacity: 1; transform: scale(1) translateY(0); }
  100% { opacity: 0; transform: scale(0.96) translateY(-18px); visibility: hidden; }
}

/* App stays hidden until splash finishes */
.app {
  opacity: 0;
  transform: translateY(8px);
  transition: opacity 0.45s ease, transform 0.45s ease;
}

.app.app-ready {
  opacity: 1;
  transform: translateY(0);
}



   #playerBar {
     padding: 12px 18px;
     margin-top: 10px;
     border-radius: 18px;
     background: rgba(255, 255, 255, 0.06);
     backdrop-filter: blur(12px);
   }

   .time-row {
     display: flex;
     justify-content: space-between;
     font-size: 11px;
     opacity: 0.75;
     margin-bottom: 6px;
   }

   #seekBar {
     width: 100%;
     -webkit-appearance: none;
     appearance: none;
     height: 4px;
     border-radius: 999px;
     background: rgba(255, 255, 255, 0.22);
     outline: none;
     margin-bottom: 12px;
   }

   #seekBar::-webkit-slider-thumb {
     width: 14px;
     height: 14px;
     border-radius: 50%;
     background: #ffffff;
     -webkit-appearance: none;
   }

   .player-controls {
     display: flex;
     justify-content: center;
     gap: 22px;
   }

   .player-controls button {
     background: linear-gradient(135deg, #ffb347, #ff7a18);
     color: #fff;
     border: none;
     padding: 10px 18px;
     border-radius: 14px;
     font-size: 20px;
     box-shadow: 0 0 15px rgba(255, 122, 24, 0.4);
     transition: 0.15s ease;
   }

   .player-controls button:active {
     transform: scale(0.9);
     box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
   }

</style>
  
</head>

<body>
  <!-- Ayrix opening splash -->
  <div id="ayrix-splash">
    <div class="ayrix-splash-inner">
      <div class="ayrix-splash-logo-wrap">
        <img src="icons/ayrix-icon-192.png" alt="Ayrix logo" class="ayrix-splash-logo">
      </div>
      <div class="ayrix-splash-title">AYRIX</div>
      <div class="ayrix-splash-subtitle">Stay synced, stay close ü§ç</div>
    </div>
  </div>
  
  <div class="app">
    ...
    <h1>Ayrix ‚Äì Live Sync Player</h1>
    

    
    <div class="subtitle">Ayrix by Aman, with luvv ‚Ä¢ Stay synced, stay close ü§ç</div>

    

    <button id="hostToggle">Become host</button>
    <div id="status">You are a listener. Wait for host to play a song.</div>

    <div id="playerBar">
  <!-- Time row -->
  <div class="time-row">
    <span id="currentTime">0:00</span>
    <span id="totalTime">0:00</span>
  </div>

  <!-- Progress line -->
  <input
    type="range"
    id="seekBar"
    min="0"
    max="100"
    value="0"
    step="0.1"
  />

  <!-- Buttons below -->
  <div class="player-controls">
    <button id="prevBtn">‚è™</button>
    <button id="playPauseBtn">‚ñ∂</button>
    <button id="nextBtn">‚è©</button>
  </div>

  <!-- Hidden real audio -->
  <audio id="player"></audio>

</div>


    <div id="songs">Loading songs‚Ä¶</div>
  </div>

  <script>
  const splash = document.getElementById("ayrix-splash");
  const app = document.querySelector(".app");

  if (splash && app) {
    app.classList.remove("app-ready");

    setTimeout(() => {
      splash.classList.add("hide");
    }, 1600); // 1.6s splash

    setTimeout(() => {
      splash.remove();
      app.classList.add("app-ready");
    }, 2300); // splash out + app fade-in
  }
</script>


  <script type="module">
    // ====== GOOGLE DRIVE STREAM CONFIG ======
    const GOOGLE_API_KEY = "AIzaSyA06vHg4uelFoqLIs-dVBF_trQ7qBtR7TU";

    // ---------- SONG LIST (tumhare links) ----------
    // ------------ SONG LIST (loaded from Ayrix JSON API) ---------
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxSf4pGRfrEH3Y8nN9-mqGy6OT2z5BjXsWUlHFlha25lpnsQtR4xjSXnU7MDv1HLcZW6g/exec";
let SONGS = [];

// ================= CUSTOM PLAYER CONTROLS =================

const audioPlayer = document.getElementById("player");
const prevBtn = document.getElementById("prevBtn");
const playPauseBtn = document.getElementById("playPauseBtn");
const nextBtn = document.getElementById("nextBtn");
const seekBar = document.getElementById("seekBar");
const currentTimeEl = document.getElementById("currentTime");
const totalTimeEl = document.getElementById("totalTime");

let currentSongIndex = 0;

// Load song by index
function loadSong(index) {
    const song = SONGS[index];
    if (!song) return;
    const url = toStreamUrl(song.url);
    audioPlayer.src = url;
    audioPlayer.currentTime = 0;
    audioPlayer.play();
    highlightPlaying(url);
    sendState();
}

// Play/Pause button
playPauseBtn.addEventListener("click", () => {
    if (audioPlayer.paused) {
        audioPlayer.play();
        playPauseBtn.innerText = "‚è∏";
    } else {
        audioPlayer.pause();
        playPauseBtn.innerText = "‚ñ∂";
    }
});

// Previous button
prevBtn.addEventListener("click", () => {
    currentSongIndex = (currentSongIndex - 1 + SONGS.length) % SONGS.length;
    loadSong(currentSongIndex);
});

// Next button
nextBtn.addEventListener("click", () => {
    currentSongIndex = (currentSongIndex + 1) % SONGS.length;
    loadSong(currentSongIndex);
});

// Update seek bar + time
audioPlayer.addEventListener("timeupdate", () => {
    const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    seekBar.value = progress || 0;

    currentTimeEl.innerText = formatTime(audioPlayer.currentTime);
    totalTimeEl.innerText = formatTime(audioPlayer.duration);
});

// Seek manually
seekBar.addEventListener("input", () => {
    const time = (seekBar.value / 100) * audioPlayer.duration;
    audioPlayer.currentTime = time;
});

// Format time
function formatTime(sec) {
    if (!sec) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
}

// Robust extraction of Drive fileId from many link formats
function toStreamUrl(driveUrl) {
  if (!driveUrl) return '';
  driveUrl = driveUrl.trim();

  // Try multiple patterns: /d/FILEID, id=FILEID, open?id=FILEID, or raw FILEID
  let fileId = null;

  // pattern /d/FILEID/
  const dMatch = driveUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (dMatch && dMatch[1]) fileId = dMatch[1];

  // pattern id=FILEID or open?id=FILEID
  if (!fileId) {
    const idMatch = driveUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (idMatch && idMatch[1]) fileId = idMatch[1];
  }

  // if still not found and string looks like a bare id
  if (!fileId) {
    const maybeId = driveUrl.match(/^([a-zA-Z0-9_-]{10,})$/);
    if (maybeId) fileId = maybeId[1];
  }

  if (!fileId) {
    console.warn('toStreamUrl: could not extract fileId from', driveUrl);
    return '';
  }

  return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${GOOGLE_API_KEY}`;
}

  

    // ---------- FIREBASE ----------
    import {
  getDatabase,
  ref,
  onValue,
  update,
  push,
  onChildAdded
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";


    const firebaseConfig = {
  apiKey: "AIzaSyDgCke5Pv2nQdFo7LalikW50N6haayuIS0",
  authDomain: "ayrix-chat.firebaseapp.com",
  databaseURL: "https://ayrix-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ayrix-chat",
  storageBucket: "ayrix-chat.firebasestorage.app",
  messagingSenderId: "337316616818",
  appId: "1:337316616818:web:45b2fc628daf31598f80eb"
};


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const sessionRef = ref(db, "sessions/ayrix");
    
    // ---- TEMP TEST BUTTON (JS only, safe to paste inside your existing script) ----
(function addTestButton(){
  try {
    const btn = document.getElementById('ayrix-test-btn');
    if (btn) return; // already added
    const b = document.createElement('button');
    b.id = 'ayrix-test-btn';
    b.textContent = 'TEST';
    Object.assign(b.style, {
      position: 'fixed',
      right: '10px',
      bottom: '10px',
      zIndex: 99999,
      padding: '8px 10px',
      background: '#111',
      color: '#fff',
      border: 'none',
      borderRadius: '8px',
      fontSize: '13px',
      cursor: 'pointer',
      opacity: '0.95'
    });
    b.addEventListener('click', () => {
      console.log('Running test‚Ä¶');
      const examples = (typeof SONGS !== 'undefined' && Array.isArray(SONGS) && SONGS.length)
        ? SONGS.map(s => s.url)
        : ['no songs found'];
      examples.forEach(u => console.log(u, '->', (typeof toStreamUrl === 'function') ? toStreamUrl(u) : 'toStreamUrl NOT found'));
      alert('Test finished. Open Chrome ‚Üí Menu ‚Üí History ‚Üí "Developer console messages" to see logs.');
    });
    // wait for body then append
    if (document.body) document.body.appendChild(b);
    else window.addEventListener('DOMContentLoaded', () => document.body.appendChild(b));
  } catch (e) {
    console.error('addTestButton error', e);
  }
})();


    // --- VISUAL DEBUG OVERLAY (temporary) ---
(function setupVisualDebug() {
  // small floating panel to show logs on-screen (temporary)
  const dbg = document.createElement('div');
  dbg.id = 'ayrix-debug';
  dbg.style.position = 'fixed';
  dbg.style.right = '12px';
  dbg.style.bottom = '12px';
  dbg.style.maxWidth = '46vw';
  dbg.style.maxHeight = '40vh';
  dbg.style.overflow = 'auto';
  dbg.style.zIndex = 99999;
  dbg.style.background = 'rgba(0,0,0,0.75)';
  dbg.style.color = 'white';
  dbg.style.fontSize = '12px';
  dbg.style.padding = '8px';
  dbg.style.borderRadius = '10px';
  dbg.style.backdropFilter = 'blur(6px)';
  dbg.style.boxShadow = '0 6px 20px rgba(0,0,0,0.6)';
  dbg.innerHTML = '<b>Ayrix debug</b><div id="ayrix-debug-content" style="margin-top:6px"></div>';
  document.body.appendChild(dbg);

  function appendLog(type, msg) {
    const c = document.getElementById('ayrix-debug-content');
    const el = document.createElement('div');
    el.style.marginBottom = '6px';
    el.style.whiteSpace = 'pre-wrap';
    el.textContent = `[${type}] ${msg}`;
    c.appendChild(el);
    c.scrollTop = c.scrollHeight;
  }

  // forward console messages here too
  const originalLog = console.log.bind(console);
  const originalError = console.error.bind(console);
  console.log = (...args) => { originalLog(...args); appendLog('log', args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ')); };
  console.error = (...args) => { originalError(...args); appendLog('err', args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ')); };

  // quick runtime checks (will run once)
  try {
    appendLog('info', 'running quick runtime checks...');
    appendLog('info', 'SCRIPT_URL value: ' + (typeof SCRIPT_URL !== 'undefined' ? SCRIPT_URL : 'undefined'));
    appendLog('info', 'SONGS variable: ' + (typeof SONGS !== 'undefined' ? (Array.isArray(SONGS) ? 'array len=' + SONGS.length : typeof SONGS) : 'undefined'));
  } catch (e) {
    appendLog('err', 'quick check error: ' + String(e));
  }

  // try fetching the SCRIPT_URL to verify JSON (only if set)
  (async () => {
    if (typeof SCRIPT_URL === 'undefined') {
      appendLog('warn', 'SCRIPT_URL is undefined ‚Äî update SCRIPT_URL in code.');
      return;
    }
    appendLog('info', 'fetching SCRIPT_URL...');
    try {
      const r = await fetch(SCRIPT_URL, { cache: 'no-store' });
      appendLog('info', 'fetch status: ' + r.status + ' ' + r.statusText);
      const txt = await r.text();
      appendLog('info', 'response length: ' + txt.length + ' chars');
      try {
        const j = JSON.parse(txt);
        appendLog('info', 'JSON parsed OK ‚Äî keys: ' + Object.keys(j).join(', '));
        if (Array.isArray(j.songs)) appendLog('info', 'songs count in API: ' + j.songs.length);
      } catch (pe) {
        appendLog('err', 'JSON parse failed: ' + pe.message);
        appendLog('err', 'response preview: ' + txt.slice(0,800));
      }
    } catch (fe) {
      appendLog('err', 'fetch failed: ' + fe.message);
    }
  })();
})();


    // --- QUICK CHAT DB TEST (temporary) ---
const testRoomRef = ref(db, 'rooms/test_room/messages');

// Listen for new messages in test room
onChildAdded(testRoomRef, (snap) => {
  console.log('[DB LISTENER] New msg:', snap.key, snap.val());
});

// Push a test message (will create the path if not exists)
push(testRoomRef, {
  uid: 'test-user',
  text: 'hello from ayrix test!',
  ts: Date.now()
})
.then(() => console.log('[DB WRITE] Test message pushed OK'))
.catch(err => console.error('[DB WRITE ERROR]', err));



    // ---------- UI ELEMENTS ----------
    const audio = document.getElementById("player");
    const hostToggle = document.getElementById("hostToggle");
    const statusEl = document.getElementById("status");
    const songsContainer = document.getElementById("songs");

    let isHost = false;

    // ---------- HOST TOGGLE ----------
    hostToggle.addEventListener("click", () => {
      isHost = !isHost;
      if (isHost) {
        hostToggle.classList.add("host");
        hostToggle.textContent = "You are host ‚úÖ";
        statusEl.textContent =
          "You are host. Whatever you play will sync to connected devices.";
        sendState();
      } else {
        hostToggle.classList.remove("host");
        hostToggle.textContent = "Become host";
        statusEl.textContent =
          "You are a listener. Wait for host to play a song.";
      }
    });
// ---------- LOAD SONGS FROM AYRIX JSON API ----------
async function loadSongsFromApi() {
  try {
    if (songsContainer) {
      songsContainer.textContent = "Loading songs...";
    }

    const res = await fetch(SCRIPT_URL);
    const data = await res.json();

    if (!data || !Array.isArray(data.songs) || data.songs.length === 0) {
      if (songsContainer) {
        songsContainer.textContent = "No songs found in Drive folder.";
      }
      SONGS = [];
      return;
    }

    // API se aaye songs set karo
    SONGS = data.songs;

    if (songsContainer) {
      songsContainer.textContent = "";
    }

    // buttons banao + pehla song select
    buildSongButtons();
    loadSong(0);
  } catch (err) {
    console.error("Error loading songs from API:", err);
    if (songsContainer) {
      songsContainer.textContent = "Error loading songs. Please try again later.";
    }
  }
}

    // ---------- SONG BUTTONS FROM SONGS ARRAY ----------
    function buildSongButtons() {
      if (!SONGS.length) {
        songsContainer.textContent = "No songs configured.";
        return;
      }
      songsContainer.innerHTML = "";
      SONGS.forEach((song, index) => {
        const btn = document.createElement("button");
        btn.className = "song-button";
        btn.textContent = (index + 1) + ". " + song.name;
        btn.dataset.url = song.url; // original drive url

        btn.addEventListener("click", () => {
          if (!isHost) {
            alert("Only host can select songs. Tap 'Become host' on your phone.");
            return;
          }
          const streamUrl = toStreamUrl(song.url);
          playAsHost(streamUrl);
          highlightPlaying(streamUrl);
        });

        songsContainer.appendChild(btn);
      });
    }

    function highlightPlaying(url) {
      const buttons = songsContainer.querySelectorAll(".song-button");
      buttons.forEach((b) => {
        const streamForButton = toStreamUrl(b.dataset.url);
        if (streamForButton === url) {
          b.classList.add("playing");
        } else {
          b.classList.remove("playing");
        }
      });
    }

    // ---------- HOST: SEND STATE ----------
    function sendState() {
      if (!isHost) return;
      update(sessionRef, {
        songUrl: audio.src || "",
        isPlaying: !audio.paused,
        position: audio.currentTime || 0,
        updatedAt: Date.now()
      }).catch((e) => console.error("sendState error:", e));
    }

    async function playAsHost(url) {
      if (!isHost) return;
      audio.src = url;
      audio.currentTime = 0;
      try {
        await audio.play();
      } catch (e) {
        console.error("Playback error:", e);
      }
      sendState();
    }

    audio.addEventListener("play", () => sendState());
    audio.addEventListener("pause", () => sendState());
    audio.addEventListener("seeked", () => sendState());
    audio.addEventListener("ended", () => sendState());

    // ---------- LISTENER: RECEIVE STATE ----------
    onValue(sessionRef, async (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const {songUrl, isPlaying, position} = data;

      if (isHost) return; // host ignore kare

      if (songUrl && audio.src !== songUrl) {
        audio.src = songUrl;
        highlightPlaying(songUrl);
      }

      if (Math.abs(audio.currentTime - position) > 1) {
        audio.currentTime = position;
      }

      if (isPlaying && audio.paused) {
        audio.play().catch(() => { });
      } else if (!isPlaying && !audio.paused) {
        audio.pause();
      }

      statusEl.textContent = "Listening with host‚Ä¶ üéß";
    });

    // ----------- START -----------
loadSongsFromApi();

  </script>
  <!-- Ayrix Chat Widget (paste near end of body) -->
<style>
  /* Theme variables - change to match Ayrix */
  :root {
    --ayrix-p1: #ff73d1; /* pink */
    --ayrix-p2: #8b5cf6; /* purple */
    --bg-panel: rgba(10,10,12,0.95);
    --glass: rgba(255,255,255,0.04);
    --text: #f6f6f8;
    --muted: #cfc9d8;
    --radius: 14px;
  }

  /* Floating chat button */
  .ayrix-chat-button {
    position: fixed;
    right: 20px;
    bottom: 24px;
    z-index: 1200;
    width: 66px;
    height: 66px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    cursor: pointer;
    backdrop-filter: blur(6px);
    background: linear-gradient(135deg, color-mix(in srgb, var(--ayrix-p1) 55%, transparent), color-mix(in srgb, var(--ayrix-p2) 40%, transparent));
    box-shadow:
      0 6px 18px rgba(139,92,246,0.18),
      0 0 18px rgba(255,115,209,0.12),
      0 0 30px rgba(139,92,246,0.06);
    border: 1px solid rgba(255,255,255,0.06);
    transition: transform .18s ease;
  }
  .ayrix-chat-button:active { transform: scale(.98); }

  .ayrix-chat-icon {
    width: 34px;
    height: 34px;
    filter: drop-shadow(0 6px 20px rgba(139,92,246,0.16));
  }

  /* glowing outline pulse */
  .ayrix-chat-button::after {
    content: "";
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, rgba(255,115,209,0.18), transparent 8%),
                radial-gradient(circle at 80% 80%, rgba(139,92,246,0.14), transparent 18%);
    z-index: -1;
    animation: pulseGlow 2.7s infinite;
  }
  @keyframes pulseGlow {
    0% { transform: scale(.95); opacity: .9; }
    50% { transform: scale(1.12); opacity: .6; }
    100% { transform: scale(.95); opacity: .9; }
  }

  /* Badge for counts on button */
  .ayrix-badge {
    position: absolute;
    top: 6px;
    right: 6px;
    background: linear-gradient(90deg, var(--ayrix-p1), var(--ayrix-p2));
    color: #fff;
    font-size: 11px;
    padding: 4px 7px;
    border-radius: 999px;
    box-shadow: 0 6px 14px rgba(139,92,246,0.12);
  }

  /* Chat panel */
  .ayrix-chat-panel {
    position: fixed;
    right: 20px;
    bottom: 100px;
    width: 360px;
    max-width: calc(100% - 40px);
    max-height: 68vh;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--text);
    box-shadow: 0 12px 40px rgba(8,6,16,0.6);
    overflow: hidden;
    transform: translateY(18px) scale(.985);
    opacity: 0;
    pointer-events: none;
    transition: all .22s ease;
    z-index: 1250;
    backdrop-filter: blur(8px) saturate(120%);
  }
  .ayrix-chat-panel.open {
    transform: translateY(0) scale(1);
    opacity: 1;
    pointer-events: auto;
  }

  .ayrix-chat-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  .ayrix-chat-title {
    display:flex;
    gap:10px;
    align-items:center;
    font-weight:700;
    font-size:15px;
    color:var(--text);
  }
  .ayrix-chat-counters {
    display:flex;
    gap:8px;
    align-items:center;
  }
  .ayrix-counter {
    font-size:12px;
    padding:6px 8px;
    border-radius:10px;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.03);
    color:var(--muted);
  }

  .ayrix-chat-close {
    background: transparent;
    border: 0;
    color: var(--muted);
    font-weight:700;
    cursor:pointer;
    padding:6px;
    border-radius:8px;
  }
  .ayrix-chat-close:hover { color:var(--text); background:var(--glass); }

  /* messages area */
  .ayrix-chat-body {
    padding:12px;
    overflow:auto;
    height: calc(68vh - 160px);
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .ayrix-msg {
    max-width:78%;
    padding:8px 10px;
    border-radius:12px;
    font-size:13px;
    line-height:1.2;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.003));
    border:1px solid rgba(255,255,255,0.03);
    color:var(--text);
  }
  .ayrix-msg.me {
    align-self:flex-end;
    background: linear-gradient(135deg, rgba(255,115,209,0.12), rgba(139,92,246,0.08));
    border: 1px solid rgba(255,115,209,0.14);
    box-shadow: 0 6px 18px rgba(139,92,246,0.04);
  }
  .ayrix-msg.other {
    align-self:flex-start;
    background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }

  /* input area */
  .ayrix-chat-input {
    display:flex;
    gap:8px;
    padding:12px;
    border-top:1px solid rgba(255,255,255,0.03);
    align-items:center;
  }
  .ayrix-input-field {
    flex:1;
    min-height:44px;
    border-radius:12px;
    padding:10px 12px;
    background: rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.03);
    color:var(--text);
    resize:none;
    outline: none;
    font-size:14px;
  }
  .ayrix-send-btn {
    padding:10px 12px;
    border-radius:12px;
    background: linear-gradient(90deg,var(--ayrix-p1),var(--ayrix-p2));
    border:0;
    color:white;
    cursor:pointer;
    font-weight:700;
  }

  /* small responsive */
  @media (max-width:520px) {
    .ayrix-chat-panel {
      right: 12px;
      left: 12px;
      width: auto;
      bottom: 84px;
    }
    .ayrix-chat-body { height: calc(60vh - 140px); }
  }
</style>

<!-- Button -->
<div id="ayrixChatBtn" class="ayrix-chat-button" role="button" aria-label="Open chat" title="Chat">
  <!-- simple chat bubble svg -->
  <svg class="ayrix-chat-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <div id="ayrixBtnBadge" class="ayrix-badge" style="display:none">0</div>
</div>

<!-- Chat Panel -->
<div id="ayrixChatPanel" class="ayrix-chat-panel" role="dialog" aria-hidden="true" aria-label="Ayrix Chat">
  <div class="ayrix-chat-header">
    <div class="ayrix-chat-title">
      <div style="width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,var(--ayrix-p1),var(--ayrix-p2));box-shadow:0 6px 18px rgba(139,92,246,0.12)"></div>
      <div>Ayrix Chat</div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div class="ayrix-chat-counters" aria-hidden="true">
        <div id="ayrixAppCount" class="ayrix-counter">App: 0</div>
        <div id="ayrixChatCount" class="ayrix-counter">Chat: 0</div>
      </div>
      <button id="ayrixCloseBtn" class="ayrix-chat-close" aria-label="Close chat">‚úï</button>
    </div>
  </div>

  <div id="ayrixChatBody" class="ayrix-chat-body" aria-live="polite"></div>

  <div class="ayrix-chat-input">
    <textarea id="ayrixMsgInput" class="ayrix-input-field" placeholder="Say something nice..." rows="1"></textarea>
    <button id="ayrixSendBtn" class="ayrix-send-btn">Send</button>
  </div>
</div>

<script>
  // Simple chat widget behavior + integration helpers
  (function(){
    const btn = document.getElementById('ayrixChatBtn');
    const panel = document.getElementById('ayrixChatPanel');
    const closeBtn = document.getElementById('ayrixCloseBtn');
    const sendBtn = document.getElementById('ayrixSendBtn');
    const input = document.getElementById('ayrixMsgInput');
    const body = document.getElementById('ayrixChatBody');
    const appCountEl = document.getElementById('ayrixAppCount');
    const chatCountEl = document.getElementById('ayrixChatCount');
    const badge = document.getElementById('ayrixBtnBadge');

    // open/close
    function openChat() {
      panel.classList.add('open');
      panel.setAttribute('aria-hidden','false');
      // optional: reset unread badge
      badge.style.display = 'none';
    }
    function closeChat() {
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden','true');
    }

    btn.addEventListener('click', openChat);
    closeBtn.addEventListener('click', closeChat);

    // send sample message (you should replace with your socket/fetch)
    function appendMessage(text, who='other') {
      const el = document.createElement('div');
      el.className = 'ayrix-msg ' + (who === 'me' ? 'me' : 'other');
      el.textContent = text;
      body.appendChild(el);
      body.scrollTop = body.scrollHeight;
    }

    sendBtn.addEventListener('click', () => {
      const txt = input.value.trim();
      if(!txt) return;
      appendMessage(txt, 'me');
      input.value = '';
      // hook: call sendToServer(txt)
      if(typeof window.ayrixSendToServer === 'function') {
        window.ayrixSendToServer(txt);
      } else {
    appendMessage('(Not connected: message not delivered)', 'other');
}
  });

    // allow Enter to send (Shift+Enter for new line)
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Exported helpers for integration
    window.ayrixChat = {
      open: openChat,
      close: closeChat,
      appendMessage,
      // update counts: {app: number, chat: number}
      updateCounts: function(obj){
        if(typeof obj !== 'object') return;
        if(typeof obj.app === 'number') {
          appCountEl.textContent = 'App: ' + obj.app;
        }
        if(typeof obj.chat === 'number') {
          chatCountEl.textContent = 'Chat: ' + obj.chat;
          // show tiny badge with number of unread chat users or something
          if(obj.chat > 0) {
            badge.textContent = obj.chat;
            badge.style.display = 'block';
          } else {
            badge.style.display = 'none';
          }
        }
      }
    };

    // Example: small welcome messages (remove in production)
    appendMessage('Welcome to Ayrix chat! Be kind üíú','other');
  })();
</script>

</body>

</html> 
