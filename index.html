<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ayrix ‚Äî Refined Index</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/ayrix-icon-192.png">
  <meta name="theme-color" content="#05000b">

  <style>
    /* Minimal, cleaned styles based on your theme */
    *{box-sizing:border-box}
    body{margin:0;padding:16px;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at top,#ff4da6 0,transparent 55%),radial-gradient(circle at bottom,#7b5dff 0,transparent 55%),#050515;color:#f8f2ff;min-height:100vh;display:flex;align-items:center;justify-content:center}
    .app{width:92%;max-width:760px;margin:0 auto;background:rgba(8,6,24,0.96);border-radius:20px;padding:20px;box-shadow:0 18px 45px rgba(0,0,0,.7),0 0 35px rgba(255,77,166,.45);backdrop-filter:blur(12px)}
    h1{text-align:center;margin:0 0 6px;font-size:1.4rem}
    .subtitle{text-align:center;font-size:0.85rem;margin-bottom:12px;opacity:.9}
    #hostToggle{display:block;width:100%;padding:12px;border-radius:999px;border:none;font-size:.95rem;margin-bottom:10px;cursor:pointer;background:linear-gradient(90deg,#252047,#342a63);color:#f6ebff}
    #hostToggle.host{background:linear-gradient(90deg,#ff4fa0,#ff7edb);box-shadow:0 0 18px rgba(255,79,160,.45)}
    #status{text-align:center;font-size:.85rem;margin-bottom:8px}
    #songs{max-height:420px;overflow:auto;margin-top:10px;padding-right:6px}
    .song-button{width:100%;padding:10px 12px;margin-bottom:8px;border-radius:12px;border:none;text-align:left;cursor:pointer;background:rgba(23,18,52,.95);color:#f7e9ff}
    .song-button.playing{background:linear-gradient(90deg,#ff4fa0,#7f5dff);color:#fff}
    #playerBar{padding:12px;border-radius:14px;background:rgba(255,255,255,.04);margin-top:12px}
    .player-controls{display:flex;justify-content:center;gap:18px}
    audio{width:100%;display:block}
    /* Debug overlay (small) */
    #ayrix-debug{position:fixed;right:12px;bottom:12px;z-index:9999;background:rgba(0,0,0,0.7);color:#fff;padding:8px;border-radius:10px;font-size:12px;max-width:45vw;max-height:40vh;overflow:auto}
  </style>

  <script>
    // Register service worker (non-blocking)
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  </script>
</head>
<body>
  <div class="app" id="root">
    <h1>Ayrix ‚Äî Live Sync Player</h1>
    <div class="subtitle">Ayrix by Aman ‚Ä¢ Stay synced, stay close ü§ç</div>

    <button id="hostToggle">Become host</button>
    <div id="status">You are a listener. Wait for host to play a song.</div>

    <div id="playerBar">
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:8px"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div>
      <input id="seekBar" type="range" min="0" max="100" value="0" step="0.1" />
      <div class="player-controls" style="margin-top:10px">
        <button id="prevBtn">‚è™</button>
        <button id="playPauseBtn">‚ñ∂</button>
        <button id="nextBtn">‚è©</button>
      </div>
      <audio id="player" crossorigin="anonymous"></audio>
    </div>

    <div id="songs">Loading songs‚Ä¶</div>
  </div>

  <div id="ayrix-debug"><b>Ayrix debug</b><div id="ayrix-debug-content" style="margin-top:6px"></div></div>

  <script type="module">
    // ---------- CONFIG: replace placeholders before publishing ----------
    const GOOGLE_API_KEY = 'AIzaSyA06vHg4uelFoqLIs-dVBF_trQ7qBtR7TU';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSf4pGRfrEH3Y8nN9-mqGy6OT2z5BjXsWUlHFlha25lpnsQtR4xjSXnU7MDv1HLcZW6g/exec'; // <-- put your Google Apps Script URL

    const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDgCke5Pv2nQdFo7LalikW50N6haayuIS0",
  authDomain: "ayrix-chat.firebaseapp.com",
  databaseURL: "https://ayrix-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ayrix-chat",
  storageBucket: "ayrix-chat.firebasestorage.app",
  messagingSenderId: "337316616818",
  appId: "1:337316616818:web:45b2fc628daf31598f80eb"
};


    // ---------- Imports (Firebase modular API) ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getDatabase, ref, onValue, update, push, onChildAdded } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    // ---------- DOM refs ----------
    const audio = document.getElementById('player');
    const hostToggle = document.getElementById('hostToggle');
    const statusEl = document.getElementById('status');
    const songsContainer = document.getElementById('songs');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const seekBar = document.getElementById('seekBar');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const dbgEl = document.getElementById('ayrix-debug-content');

    // ---------- State ----------
    let SONGS = [];
    let currentIndex = 0;
    let isHost = false;

    function dbg(msg){
      try{ const el = document.createElement('div'); el.textContent = msg; dbgEl.appendChild(el); dbgEl.scrollTop = dbgEl.scrollHeight; console.log(msg);}catch(e){}
    }

    // ---------- Firebase init ----------
    const firebaseApp = initializeApp(FIREBASE_CONFIG);
    const db = getDatabase(firebaseApp);
    const sessionRef = ref(db, 'sessions/ayrix');

    // Quick DB test (non-destructive)
    (function quickDbTest(){
      try{
        const testRef = ref(db, 'rooms/ayrix_test/messages');
        onChildAdded(testRef, snap => dbg('[DB] child added: ' + snap.key));
        push(testRef,{uid:'ayrix-debug',text:'hello from client',ts:Date.now()}).then(()=>dbg('[DB] pushed test msg')).catch(e=>dbg('[DB] push err:'+e.message));
      }catch(e){ dbg('[DB] init err:'+e.message); }
    })();

    // ---------- Utilities ----------
    function formatTime(sec){ if(!sec || !isFinite(sec)) return '0:00'; const m=Math.floor(sec/60); const s=Math.floor(sec%60).toString().padStart(2,'0'); return `${m}:${s}` }

    function extractDriveId(url){ if(!url) return null; url = url.trim(); const d = url.match(/\/d\/([a-zA-Z0-9_-]{10,})/); if(d && d[1]) return d[1]; const q = url.match(/[?&]id=([a-zA-Z0-9_-]{10,})/); if(q && q[1]) return q[1]; const bare = url.match(/^([a-zA-Z0-9_-]{20,})$/); if(bare) return bare[1]; return null }

    function driveAltMediaUrl(fileId){ if(!fileId) return ''; if(!GOOGLE_API_KEY || GOOGLE_API_KEY.startsWith('REDACTED')) return `https://drive.google.com/uc?export=download&id=${fileId}`; return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${GOOGLE_API_KEY}` }

    // lightweight normalization: removes trailing query params for simple compare
    function resolveSimple(u){ if(!u) return ''; try{ return u.split('?')[0].replace(/\/\/+$/,''); }catch(e){return u} }

    // ---------- Resolve stream URL for a given original (returns playable URL or '') ----------
    async function resolveStreamUrl(original){
      if(!original) return '';
      // if already direct to an audio file
      if(/https?:\/\/.+\.(mp3|m4a|wav|ogg|webm)(\?|$)/i.test(original)) return original;

      const fileId = extractDriveId(original);
      if(!fileId) return '';
      const direct = driveAltMediaUrl(fileId);

      // 1) quick check using Range request ‚Äî often blocked by CORS
      try{
        const r = await fetch(direct, { method:'GET', headers: { Range:'bytes=0-0' }, cache:'no-store' });
        const ct = (r.headers.get('content-type')||'').toLowerCase();
        if(r.ok && /audio|mpeg|octet-stream/.test(ct)) return direct;
      }catch(e){ dbg('[resolve] range check failed: '+e.message); }

      // 2) blob fallback (may work if CORS allows)
      try{
        const r2 = await fetch(direct, { method:'GET', cache:'no-store' });
        if(r2.ok){ const blob = await r2.blob(); if(blob.size>0) return URL.createObjectURL(blob); }
      }catch(e){ dbg('[resolve] blob fetch failed: '+e.message); }

      // 3) final fallback: webdownload link (may require auth but sometimes works)
      return `https://drive.google.com/uc?export=download&id=${fileId}`;
    }

    // ---------- Render songs ----------
    function renderSongList(){
      songsContainer.innerHTML = '';
      if(!SONGS.length){ songsContainer.textContent = 'No songs found.'; return; }
      SONGS.forEach((s,i)=>{
        const btn = document.createElement('button'); btn.className='song-button'; btn.textContent = (i+1)+'. '+(s.name||s.title||('Song '+(i+1))); btn.dataset.index = i;
        btn.addEventListener('click', async ()=>{
          if(!isHost) return alert("Only host can select songs. Tap 'Become host' first.");
          const resolved = s.streamUrl || await resolveStreamUrl(s.url);
          if(!resolved) return alert('Cannot play this song (unresolvable).');
          await playAsHost(resolved,i);
        });
        songsContainer.appendChild(btn);
      });
    }

    function markPlaying(index){ const btns = songsContainer.querySelectorAll('.song-button'); btns.forEach(b=>b.classList.remove('playing')); const chosen = songsContainer.querySelector(`.song-button[data-index="${index}"]`); if(chosen) chosen.classList.add('playing'); }

    // ---------- Core player controls ----------
    playPauseBtn.addEventListener('click', async ()=>{ if(audio.paused){ try{ await audio.play(); playPauseBtn.textContent='‚è∏'; }catch(e){ dbg('[play] failed: '+e.message); } } else { audio.pause(); playPauseBtn.textContent='‚ñ∂'; } sendState(); });

    prevBtn.addEventListener('click', ()=>{ if(!SONGS.length) return; currentIndex = (currentIndex-1+SONGS.length)%SONGS.length; const s=SONGS[currentIndex]; if(isHost) playAsHost(s.streamUrl||s.url,currentIndex); else loadLocalSong(currentIndex); });
    nextBtn.addEventListener('click', ()=>{ if(!SONGS.length) return; currentIndex = (currentIndex+1)%SONGS.length; const s=SONGS[currentIndex]; if(isHost) playAsHost(s.streamUrl||s.url,currentIndex); else loadLocalSong(currentIndex); });

    audio.addEventListener('timeupdate', ()=>{ if(!audio.duration || !isFinite(audio.duration)) return; const percent = (audio.currentTime/audio.duration)*100; seekBar.value = percent||0; currentTimeEl.textContent = formatTime(audio.currentTime); totalTimeEl.textContent = formatTime(audio.duration); });

    seekBar.addEventListener('input', ()=>{ if(!audio.duration || !isFinite(audio.duration)) return; audio.currentTime = (seekBar.value/100)*audio.duration; sendState(); });

    // ---------- Host toggle & state sync ----------
    hostToggle.addEventListener('click', ()=>{ isHost = !isHost; hostToggle.classList.toggle('host', isHost); hostToggle.textContent = isHost ? 'You are host ‚úÖ' : 'Become host'; statusEl.textContent = isHost ? 'You are host. Whatever you play will sync to connected devices.' : 'You are a listener. Wait for host to play a song.'; if(isHost) sendState(); });

    function sendState(){ if(!isHost) return; update(sessionRef, { songUrl: audio.src||'', isPlaying: !audio.paused, position: audio.currentTime||0, updatedAt: Date.now() }).catch(e=>dbg('[sendState] '+(e.message||e))); }

    async function playAsHost(url, idx){ if(!isHost) return; let final = url; if(!/^https?:\/\//.test(final)) final = await resolveStreamUrl(url); audio.src = final; try{ await audio.play(); playPauseBtn.textContent='‚è∏'; }catch(e){ dbg('[playAsHost] '+e.message); } currentIndex = typeof idx==='number'?idx:currentIndex; markPlaying(currentIndex); sendState(); }

    function loadLocalSong(index){ const s = SONGS[index]; if(!s) return; audio.src = s.streamUrl || s.url; audio.load(); markPlaying(index); }

    audio.addEventListener('play', ()=>sendState());
    audio.addEventListener('pause', ()=>sendState());
    audio.addEventListener('seeked', ()=>sendState());
    audio.addEventListener('ended', ()=>sendState());

    // ---------- Listener: receive session state ----------
    onValue(sessionRef, async snap=>{
      try{
        const data = snap.val(); if(!data) return; if(isHost) return; const { songUrl, isPlaying, position } = data || {};
        if(songUrl && audio.src !== songUrl){ audio.src = songUrl; try{ audio.load(); }catch(e){}; // mark if known
          const idx = SONGS.findIndex(s => (s.streamUrl === songUrl) || (resolveSimple(s.url) === resolveSimple(songUrl)) );
          if(idx>=0) currentIndex = idx; markPlaying(currentIndex);
        }
        if(position != null && Math.abs((audio.currentTime||0) - position) > 1){ try{ audio.currentTime = position; }catch(e){} }
        if(isPlaying && audio.paused) audio.play().catch(()=>{}); else if(!isPlaying && !audio.paused) audio.pause();
        statusEl.textContent = 'Listening with host‚Ä¶ üéß';
      }catch(e){ dbg('[onValue] '+e.message); }
    });

    // ---------- Load songs from your Google Apps Script API ----------
    async function loadSongsFromApi(){
      songsContainer.textContent = 'Loading songs‚Ä¶'; dbg('[loadSongsFromApi] fetching: '+SCRIPT_URL);
      try{
        const r = await fetch(SCRIPT_URL, { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const txt = await r.text();
        let data;
        try{ data = JSON.parse(txt); }catch(e){ // maybe the API returns a raw array
          dbg('[load] JSON parse failed: '+e.message);
          try{ data = eval(txt); }catch(e2){ data = null; }
        }

        // Accept either an array directly or { songs: [...] } object
        let list = [];
        if(Array.isArray(data)) list = data;
        else if(data && Array.isArray(data.songs)) list = data.songs;
        else if(data && Array.isArray(data.items)) list = data.items;

        if(!Array.isArray(list) || !list.length){ songsContainer.textContent = 'No songs found in API.'; SONGS = []; dbg('[load] no songs'); return; }

        // Normalize song objects: { name/title, url }
        SONGS = list.map(it => typeof it === 'string' ? { name: '', url: it } : (it.url ? it : { name: it.name||it.title||'', url: it.url || it.link || '' }));

        // Pre-resolve streamUrl for each song (best-effort, do sequentially to avoid parallel throttling)
        for(let i=0;i<SONGS.length;i++){
          const s = SONGS[i];
          try{ const resolved = await resolveStreamUrl(s.url); if(resolved) s.streamUrl = resolved; dbg(`[resolve] ${i}: ${resolved? 'OK':'FAILED'} (${s.url})`); }catch(e){ dbg('[resolve] err:'+e.message); s.streamUrl=''; }
        }

        renderSongList();

        // Auto-load first playable
        const firstPlayable = SONGS.findIndex(s=>s.streamUrl||(/https?:\/\/.+\.(mp3|m4a|wav|ogg|webm)(\?|$)/i.test(s.url)));
        if(firstPlayable>=0){ currentIndex = firstPlayable; const s = SONGS[firstPlayable]; audio.src = s.streamUrl || s.url; audio.load(); markPlaying(firstPlayable); dbg('[loadSongsFromApi] first playable index='+firstPlayable); }

      }catch(e){ dbg('[loadSongsFromApi] error: '+(e.message||e)); songsContainer.textContent = 'Error loading songs. Open debug to see details.'; }
    }

    // Start
    loadSongsFromApi().catch(e=>dbg('[init] loadSongs error:'+e.message));

    // Small helper to resolve simple urls for comparison
    function resolveSimple(u){ if(!u) return ''; try{ return u.split('?')[0].replace(/\/+$/,''); }catch(e){return u} }

  </script>

  
<script>

  // === FORCE SHOW BIG DEBUG OVERLAY (temporary for debugging) ===
(function forceShowDebug(){
  try{
    const dbg = document.getElementById('ayrix-debug');
    const dbgC = document.getElementById('ayrix-debug-content');
    if(!dbg){
      // create one if not present
      const d = document.createElement('div');
      d.id = 'ayrix-debug';
      d.style.position = 'fixed';
      d.style.left = '8px';
      d.style.right = '8px';
      d.style.bottom = '8px';
      d.style.top = '8px';
      d.style.zIndex = 2147483647;
      d.style.background = 'rgba(0,0,0,0.92)';
      d.style.color = '#fff';
      d.style.padding = '12px';
      d.style.borderRadius = '12px';
      d.style.overflow = 'auto';
      d.style.fontSize = '13px';
      d.style.backdropFilter = 'blur(6px)';
      const inner = document.createElement('div');
      inner.id = 'ayrix-debug-content';
      inner.style.whiteSpace = 'pre-wrap';
      d.appendChild(inner);
      document.body.appendChild(d);
    } else {
      // enlarge existing
      dbg.style.left = '8px';
      dbg.style.right = '8px';
      dbg.style.top = '8px';
      dbg.style.bottom = '8px';
      dbg.style.zIndex = 2147483647;
      dbg.style.background = 'rgba(0,0,0,0.92)';
      dbg.style.padding = '12px';
      dbg.style.overflow = 'auto';
      dbg.style.fontSize = '13px';
      dbg.style.borderRadius = '8px';
      dbg.style.display = 'block';
    }
    // make sure logs go there (forward console)
    const origLog = console.log.bind(console);
console.log = (...args) => {
  origLog(...args);
  try{
    const c = document.getElementById('ayrix-debug-content');
    if(c) c.textContent += args.map(a=> (typeof a==='object'?JSON.stringify(a):String(a))).join(' ') + '\n';
    if(c) c.scrollTop = c.scrollHeight;
  }catch(e){}
};

    const origErr = console.error.bind(console);
    console.error = (...args) => {
      origErr(...args);
      try{
        const c = document.getElementById('ayrix-debug-content');
        if(c) c.textContent += '[ERR] ' + args.map(a=> (typeof a==='object'?JSON.stringify(a):String(a))).join(' ') + '\\n';
        if(c) c.scrollTop = c.scrollHeight;
      }catch(e){}
    };
    console.log('[debug] forceShowDebug enabled ‚Äî logs will appear here.');
  }catch(e){
    console.error('forceShowDebug error', e);
  }
})();
</script>
</body>
</html>
